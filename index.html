<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BCA Point 2.0 - Admin Panel v2.1</title>
    <!-- Updated with notifications system -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üìö BCA Point 2.0 Admin Panel</h1>
            <button id="logoutBtn" class="btn btn-danger" style="display: none;">Logout</button>
        </header>

        <div id="loginSection" class="section">
            <div class="card">
                <h2>Admin Login</h2>
                <form id="passwordLoginForm">
                    <input type="password" id="adminPassword" placeholder="Enter Admin Password" required>
                    <button type="submit" class="btn btn-primary">Login</button>
                </form>
            </div>
        </div>

        <div id="adminSection" style="display: none;">
            <div class="tabs">
                <button class="tab-btn active" data-tab="categories">Categories</button>
                <button class="tab-btn" data-tab="subcategories">Subcategories</button>
                <button class="tab-btn" data-tab="materials">Study Materials</button>
                <button class="tab-btn" data-tab="notifications">üì¢ Notifications</button>
            </div>

            <!-- Categories Tab -->
            <div id="categories" class="tab-content active">
                <div class="card">
                    <h2>Add Category</h2>
                    <form id="categoryForm">
                        <input type="text" id="categoryTitle" placeholder="Category Title" required>
                        <textarea id="categoryDescription" placeholder="Description (optional)"></textarea>
                        <input type="number" id="categoryOrder" placeholder="Order" value="0" required>
                        <div style="margin: 15px 0; padding: 12px; background: #fff3cd; border-radius: 8px; border: 2px solid #ffc107;">
                            <label style="display: flex; align-items: center; cursor: pointer; font-weight: 600;">
                                <input type="checkbox" id="categoryIsPremium" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;">
                                <span style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 20px;">üëë</span>
                                    <span>Mark as Premium Category</span>
                                </span>
                            </label>
                            <p style="margin: 8px 0 0 30px; font-size: 13px; color: #856404;">
                                Premium categories require users to purchase premium subscription
                            </p>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Category</button>
                    </form>
                </div>                <div class="card">
                    <h2>Existing Categories</h2>
                    <div id="categoriesList"></div>
                </div>
            </div>

            <!-- Subcategories Tab -->
            <div id="subcategories" class="tab-content">
                <div class="card">
                    <h2>Add Subcategory</h2>
                    <form id="subcategoryForm">
                        <label style="font-weight: 600; margin-bottom: 5px; display: block;">Step 1: Select Category</label>
                        <select id="subcategoryCategory" required>
                            <option value="">üìÅ Select a Category</option>
                        </select>
                        
                        <div id="subcategoryLevels"></div>
                        
                        <div style="margin-top: 10px; padding: 10px; background: #f0f0ff; border-radius: 8px; font-size: 14px; display: none;" id="selectedPath">
                            <strong>Selected Path:</strong> <span id="pathDisplay"></span>
                        </div>
                        
                        <label style="font-weight: 600; margin-bottom: 5px; margin-top: 15px; display: block;">Step 2: Enter Subcategory Details</label>
                        <input type="text" id="subcategoryTitle" placeholder="Subcategory Title" required>
                        <textarea id="subcategoryDescription" placeholder="Description (optional)"></textarea>
                        <input type="number" id="subcategoryOrder" placeholder="Order" value="0" required>
                        <button type="submit" class="btn btn-primary">Add Subcategory</button>
                    </form>
                </div>
                <div class="card">
                    <h2>Existing Subcategories (Tree View)</h2>
                    <div id="subcategoriesList"></div>
                </div>
            </div>

            <!-- Study Materials Tab -->
            <div id="materials" class="tab-content">
                <div class="card">
                    <h2>Add Study Material</h2>
                    <form id="materialForm">
                        <label style="font-weight: 600; margin-bottom: 5px; display: block;">Step 1: Select Location</label>
                        <select id="materialCategory" required>
                            <option value="">üìÅ Select a Category</option>
                        </select>
                        
                        <div id="materialLevels"></div>
                        
                        <div style="margin-top: 10px; padding: 10px; background: #f0f0ff; border-radius: 8px; font-size: 14px; display: none;" id="materialSelectedPath">
                            <strong>Selected Path:</strong> <span id="materialPathDisplay"></span>
                        </div>
                        
                        <label style="font-weight: 600; margin-bottom: 5px; margin-top: 15px; display: block;">Step 2: Enter Material Details</label>
                        <input type="text" id="materialTitle" placeholder="Material Title" required>
                        <textarea id="materialDescription" placeholder="Description (optional)"></textarea>
                        
                        <div style="margin: 15px 0; padding: 15px; background: #f0f8ff; border-radius: 8px; border: 2px solid #2196f3;">
                            <p style="font-weight: bold; margin: 0 0 10px 0; color: #1976d2;">üìé Upload Content (Choose at least one)</p>
                            
                            <label style="font-weight: 600; margin-bottom: 5px; display: block;">PDF File (Optional)</label>
                            <input type="file" id="materialPdf" accept=".pdf">
                            <p style="font-size: 12px; color: #666; margin: 5px 0 15px 0;">Upload a PDF document</p>
                            
                            <label style="font-weight: 600; margin-bottom: 5px; display: block;">Images (Optional)</label>
                            <input type="file" id="materialImages" accept="image/*" multiple>
                            <p style="font-size: 12px; color: #666; margin: 5px 0 0 0;">Upload one or multiple images (JPG, PNG, etc.)</p>
                        </div>
                        <input type="number" id="materialOrder" placeholder="Order" value="0" required>
                        <div style="margin: 15px 0; padding: 12px; background: #e8f5e9; border-radius: 8px; border: 2px solid #4caf50;">
                            <label style="display: flex; align-items: center; cursor: pointer; font-weight: 600;">
                                <input type="checkbox" id="materialIsAdFree" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;">
                                <span style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 20px;">üö´</span>
                                    <span>Skip Rewarded Ads</span>
                                </span>
                            </label>
                            <p style="margin: 8px 0 0 30px; font-size: 13px; color: #2e7d32;">
                                Students can access this material instantly without watching rewarded ads (banner ads will still show)
                            </p>
                        </div>
                        <button type="submit" class="btn btn-primary">Upload Material</button>
                        <div id="uploadProgress" style="display: none;">
                            <progress id="progressBar" value="0" max="100"></progress>
                            <span id="progressText">0%</span>
                        </div>
                    </form>
                </div>
                <div class="card">
                    <h2>Existing Study Materials</h2>
                    <div id="materialsList"></div>
                </div>
            </div>

            <!-- Notifications Tab -->
            <div id="notifications" class="tab-content">
                <div class="card">
                    <h2>üì¢ Send In-App Notification</h2>
                    <form id="notificationForm">
                        <label style="font-weight: 600; margin-bottom: 5px; display: block;">Notification Type</label>
                        <select id="notificationType" required>
                            <option value="">Select Type</option>
                            <option value="new_category">üÜï New Category Added</option>
                            <option value="new_material">üìÑ New Material Added</option>
                            <option value="premium">üëë Join Premium</option>
                            <option value="announcement">üì£ General Announcement</option>
                            <option value="update">üîÑ App Update</option>
                        </select>
                        
                        <label style="font-weight: 600; margin-bottom: 5px; display: block;">Title</label>
                        <input type="text" id="notificationTitle" placeholder="Notification Title" required maxlength="50">
                        
                        <label style="font-weight: 600; margin-bottom: 5px; display: block;">Message</label>
                        <textarea id="notificationMessage" placeholder="Notification message" required maxlength="200" rows="3"></textarea>
                        
                        <label style="font-weight: 600; margin-bottom: 5px; display: block;">Target Audience</label>
                        <select id="notificationAudience" required>
                            <option value="all">All Users</option>
                            <option value="free">Free Users Only</option>
                            <option value="premium">Premium Users Only</option>
                        </select>
                        
                        <button type="submit" class="btn btn-primary">üì§ Send Notification</button>
                    </form>
                </div>
                
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0;">Recent Notifications</h2>
                        <button id="refreshNotificationsBtn" class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;">üîÑ Refresh</button>
                    </div>
                    <div id="notificationsList"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDbGQvEoVsBqLYiiYsy_5JD3Xz6TUKIq0c",
            authDomain: "bca-point-2.firebaseapp.com",
            projectId: "bca-point-2",
            storageBucket: "bca-point-2.firebasestorage.app",
            messagingSenderId: "172385715450",
            appId: "1:172385715450:web:d87c9818b5990e82b0b543",
            measurementId: "G-HNGS5B7N9Y"
        };

        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Admin password (you can change this)
        const ADMIN_PASSWORD = 'admin123';

        // DOM Elements
        const loginSection = document.getElementById('loginSection');
        const adminSection = document.getElementById('adminSection');
        const passwordLoginForm = document.getElementById('passwordLoginForm');
        const logoutBtn = document.getElementById('logoutBtn');

        // Check if already logged in
        if (sessionStorage.getItem('adminLoggedIn') === 'true') {
            loginSection.style.display = 'none';
            adminSection.style.display = 'block';
            logoutBtn.style.display = 'block';
            loadAllData();
        }

        // Password Login
        passwordLoginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const password = document.getElementById('adminPassword').value;
            
            if (password === ADMIN_PASSWORD) {
                sessionStorage.setItem('adminLoggedIn', 'true');
                loginSection.style.display = 'none';
                adminSection.style.display = 'block';
                logoutBtn.style.display = 'block';
                loadAllData();
            } else {
                alert('Incorrect password!');
            }
        });

        // Sign Out
        logoutBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to logout?')) {
                sessionStorage.removeItem('adminLoggedIn');
                loginSection.style.display = 'flex';
                adminSection.style.display = 'none';
                logoutBtn.style.display = 'none';
            }
        });

        // Tab Navigation
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;
                
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                btn.classList.add('active');
                document.getElementById(tabName).classList.add('active');
                
                // Load notifications when notifications tab is clicked
                if (tabName === 'notifications') {
                    loadNotifications();
                }
            });
        });

        // Categories
        document.getElementById('categoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const title = document.getElementById('categoryTitle').value;
            const description = document.getElementById('categoryDescription').value;
            const order = parseInt(document.getElementById('categoryOrder').value);
            
            try {
                await addDoc(collection(db, 'categories'), {
                    title,
                    description: description || null,
                    order,
                    createdAt: new Date().toISOString()
                });
                
                alert('Category added successfully!');
                e.target.reset();
                loadCategories();
            } catch (error) {
                alert('Error adding category: ' + error.message);
            }
        });

        // Global variables for cascading dropdowns
        let allCategories = [];
        let allSubcategories = [];

        async function loadCategories() {
            const q = query(collection(db, 'categories'), orderBy('order'));
            const snapshot = await getDocs(q);
            
            allCategories = [];
            const categoriesList = document.getElementById('categoriesList');
            const subcategoryCategory = document.getElementById('subcategoryCategory');
            const materialCategory = document.getElementById('materialCategory');
            
            categoriesList.innerHTML = '';
            subcategoryCategory.innerHTML = '<option value="">üìÅ Select a Category</option>';
            materialCategory.innerHTML = '<option value="">üìÅ Select a Category</option>';
            
            snapshot.forEach((doc) => {
                const data = doc.data();
                const isPremium = data.isPremium || false;
                allCategories.push({ id: doc.id, ...data });
                
                const item = document.createElement('div');
                item.className = 'item';
                item.style.borderLeft = isPremium ? '4px solid #ffc107' : '';
                item.innerHTML = `
                    <div class="item-info">
                        <h3>
                            ${isPremium ? '<span style="color: #ffc107; margin-right: 8px;">üëë</span>' : ''}
                            ${data.title}
                            ${isPremium ? '<span style="background: linear-gradient(135deg, #ffc107, #ff9800); color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px; font-weight: bold;">PREMIUM</span>' : ''}
                        </h3>
                        <p>${data.description || 'No description'} ‚Ä¢ Order: ${data.order}</p>
                    </div>
                    <div class="item-actions" style="display: flex; align-items: center; gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <span style="font-size: 12px; font-weight: bold; color: #666;">Premium:</span>
                            <label class="toggle-switch">
                                <input type="checkbox" ${isPremium ? 'checked' : ''} onchange="togglePremiumStatus('${doc.id}', this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </label>
                        <button class="btn btn-edit" onclick="editCategory('${doc.id}', '${data.title.replace(/'/g, "\\'")}', '${(data.description || '').replace(/'/g, "\\'")}', ${data.order}, ${isPremium})">Edit</button>
                        <button class="btn btn-delete" onclick="deleteCategory('${doc.id}')">Delete</button>
                    </div>
                `;
                categoriesList.appendChild(item);
                
                const option1 = document.createElement('option');
                option1.value = doc.id;
                option1.textContent = `üìÅ ${data.title}`;
                subcategoryCategory.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = doc.id;
                option2.textContent = `üìÅ ${data.title}`;
                materialCategory.appendChild(option2);
            });
            
            setupCascadingDropdowns();
        }
        
        function setupCascadingDropdowns() {
            // Subcategory cascading dropdowns
            document.getElementById('subcategoryCategory').addEventListener('change', function() {
                updateSubcategoryLevels(this.value, 'subcategory');
            });
            
            // Material cascading dropdowns
            document.getElementById('materialCategory').addEventListener('change', function() {
                updateSubcategoryLevels(this.value, 'material');
            });
        }
        
        function updateSubcategoryLevels(categoryId, type) {
            const levelsContainer = document.getElementById(type === 'subcategory' ? 'subcategoryLevels' : 'materialLevels');
            const pathDisplay = document.getElementById(type === 'subcategory' ? 'selectedPath' : 'materialSelectedPath');
            const pathText = document.getElementById(type === 'subcategory' ? 'pathDisplay' : 'materialPathDisplay');
            
            levelsContainer.innerHTML = '';
            
            if (!categoryId) {
                pathDisplay.style.display = 'none';
                return;
            }
            
            const category = allCategories.find(c => c.id === categoryId);
            let currentPath = `üìÅ ${category.title}`;
            pathText.textContent = currentPath;
            pathDisplay.style.display = 'block';
            
            addSubcategoryLevel(categoryId, 'category', levelsContainer, type, currentPath, 1);
        }
        
        function addSubcategoryLevel(parentId, parentType, container, formType, currentPath, level) {
            const children = allSubcategories.filter(s => 
                (s.parentType === parentType && s.parentId === parentId) ||
                (parentType === 'category' && s.categoryId === parentId && !s.parentType)
            );
            
            if (children.length === 0) return;
            
            const select = document.createElement('select');
            select.className = 'subcategory-level-select';
            select.style.marginTop = '10px';
            select.innerHTML = `<option value="">üìÇ Select Level ${level} (Optional)</option>`;
            
            children.forEach(child => {
                const option = document.createElement('option');
                option.value = child.id;
                option.textContent = `${'  '.repeat(level)}üìÇ ${child.title}`;
                select.appendChild(option);
            });
            
            select.addEventListener('change', function() {
                // Remove all subsequent levels
                const allSelects = container.querySelectorAll('.subcategory-level-select');
                const currentIndex = Array.from(allSelects).indexOf(this);
                for (let i = currentIndex + 1; i < allSelects.length; i++) {
                    allSelects[i].remove();
                }
                
                if (this.value) {
                    const selected = allSubcategories.find(s => s.id === this.value);
                    const newPath = currentPath + ` > üìÇ ${selected.title}`;
                    const pathText = document.getElementById(formType === 'subcategory' ? 'pathDisplay' : 'materialPathDisplay');
                    pathText.textContent = newPath;
                    
                    addSubcategoryLevel(this.value, 'subcategory', container, formType, newPath, level + 1);
                } else {
                    const pathText = document.getElementById(formType === 'subcategory' ? 'pathDisplay' : 'materialPathDisplay');
                    pathText.textContent = currentPath;
                }
            });
            
            container.appendChild(select);
        }
        
        function getSelectedParent(type) {
            const categorySelect = document.getElementById(type === 'subcategory' ? 'subcategoryCategory' : 'materialCategory');
            const levelsContainer = document.getElementById(type === 'subcategory' ? 'subcategoryLevels' : 'materialLevels');
            
            const categoryId = categorySelect.value;
            if (!categoryId) return null;
            
            const levelSelects = levelsContainer.querySelectorAll('.subcategory-level-select');
            let lastSelected = null;
            
            for (let select of levelSelects) {
                if (select.value) {
                    lastSelected = { type: 'subcategory', id: select.value };
                } else {
                    break;
                }
            }
            
            if (lastSelected) {
                return lastSelected;
            } else {
                return { type: 'category', id: categoryId };
            }
        }

        window.editCategory = async (id, title, description, order) => {
            const newTitle = prompt('Edit Category Title:', title);
            if (newTitle === null) return;
            
            const newDescription = prompt('Edit Description:', description);
            if (newDescription === null) return;
            
            const newOrder = prompt('Edit Order:', order);
            if (newOrder === null) return;
            
            try {
                await updateDoc(doc(db, 'categories', id), {
                    title: newTitle,
                    description: newDescription || null,
                    order: parseInt(newOrder)
                });
                alert('Category updated successfully!');
                loadAllData();
            } catch (error) {
                alert('Error updating category: ' + error.message);
            }
        };

        window.togglePremiumStatus = async (id, isPremium) => {
            try {
                await updateDoc(doc(db, 'categories', id), {
                    isPremium: isPremium
                });
                loadCategories();
            } catch (error) {
                alert('Error updating premium status: ' + error.message);
            }
        };

        window.deleteCategory = async (id) => {
            if (confirm('Are you sure? This will also delete all subcategories and materials under this category.')) {
                try {
                    await deleteDoc(doc(db, 'categories', id));
                    alert('Category deleted successfully!');
                    loadAllData();
                } catch (error) {
                    alert('Error deleting category: ' + error.message);
                }
            }
        };

        // Subcategories
        document.getElementById('subcategoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const parent = getSelectedParent('subcategory');
            if (!parent) {
                alert('Please select a category first!');
                return;
            }
            
            const title = document.getElementById('subcategoryTitle').value;
            const description = document.getElementById('subcategoryDescription').value;
            const order = parseInt(document.getElementById('subcategoryOrder').value);
            
            try {
                await addDoc(collection(db, 'subcategories'), {
                    parentType: parent.type,
                    parentId: parent.id,
                    title,
                    description: description || null,
                    order,
                    createdAt: new Date().toISOString()
                });
                
                alert('Subcategory added successfully!');
                e.target.reset();
                document.getElementById('subcategoryLevels').innerHTML = '';
                document.getElementById('selectedPath').style.display = 'none';
                loadAllData();
            } catch (error) {
                alert('Error adding subcategory: ' + error.message);
            }
        });

        async function loadSubcategories() {
            const q = query(collection(db, 'subcategories'), orderBy('order'));
            const snapshot = await getDocs(q);
            const categoriesSnapshot = await getDocs(collection(db, 'categories'));
            
            const categoriesMap = {};
            categoriesSnapshot.forEach(doc => {
                categoriesMap[doc.id] = doc.data().title;
            });
            
            const subcategoriesMap = {};
            const subcategoriesArray = [];
            allSubcategories = []; // Update global array
            snapshot.forEach(doc => {
                const data = { id: doc.id, ...doc.data() };
                subcategoriesMap[doc.id] = data;
                subcategoriesArray.push(data);
                allSubcategories.push(data); // Update global array
            });
            
            const subcategoriesList = document.getElementById('subcategoriesList');
            
            subcategoriesList.innerHTML = '';
            
            // Helper function to calculate depth level
            function getDepthLevel(subcatId, subcatsMap) {
                const subcat = subcatsMap[subcatId];
                if (!subcat) return 0;
                
                if (subcat.parentType === 'category') {
                    return 0;
                } else {
                    return 1 + getDepthLevel(subcat.parentId, subcatsMap);
                }
            }
            
            // Helper function to build path
            function buildPath(subcatId, subcatsMap, catsMap) {
                const subcat = subcatsMap[subcatId];
                if (!subcat) return '';
                
                if (subcat.parentType === 'category') {
                    return catsMap[subcat.parentId] || 'Unknown';
                } else {
                    const parentPath = buildPath(subcat.parentId, subcatsMap, catsMap);
                    return parentPath ? `${parentPath} > ${subcatsMap[subcat.parentId]?.title || 'Unknown'}` : '';
                }
            }
            
            // Build tree structure grouped by category
            const treeByCategory = {};
            
            subcategoriesArray.forEach((data) => {
                const path = buildPath(data.id, subcategoriesMap, categoriesMap);
                const fullPath = path ? `${path} > ${data.title}` : data.title;
                const level = getDepthLevel(data.id, subcategoriesMap);
                
                // Get root category
                let rootCategoryId = data.parentId;
                let rootCategoryName = '';
                if (data.parentType === 'category') {
                    rootCategoryId = data.parentId;
                    rootCategoryName = categoriesMap[rootCategoryId] || 'Unknown';
                } else {
                    // Find root category by traversing up
                    let current = data;
                    while (current.parentType !== 'category') {
                        current = subcategoriesMap[current.parentId];
                        if (!current) break;
                    }
                    if (current) {
                        rootCategoryId = current.parentId;
                        rootCategoryName = categoriesMap[rootCategoryId] || 'Unknown';
                    }
                }
                
                if (!treeByCategory[rootCategoryId]) {
                    treeByCategory[rootCategoryId] = {
                        name: rootCategoryName,
                        items: []
                    };
                }
                
                treeByCategory[rootCategoryId].items.push({
                    id: data.id,
                    data: data,
                    path: path,
                    fullPath: fullPath,
                    level: level
                });
            });
            
            // Display tree structure
            Object.keys(treeByCategory).forEach(catId => {
                const category = treeByCategory[catId];
                
                // Category header
                const categoryHeader = document.createElement('div');
                categoryHeader.style.cssText = 'font-weight: bold; font-size: 16px; color: #667eea; margin: 20px 0 10px 0; padding: 10px; background: #f0f0ff; border-radius: 8px;';
                categoryHeader.textContent = `üìÅ ${category.name}`;
                subcategoriesList.appendChild(categoryHeader);
                
                // Sort items by level and order
                category.items.sort((a, b) => {
                    if (a.level !== b.level) return a.level - b.level;
                    return a.data.order - b.data.order;
                });
                
                // Display items
                category.items.forEach(item => {
                    const treeItem = document.createElement('div');
                    treeItem.className = `tree-item level-${Math.min(item.level, 4)}`;
                    treeItem.innerHTML = `
                        <div class="tree-item-header">
                            <div>
                                <div class="tree-item-title">${'‚îî‚îÄ '.repeat(item.level)}${item.data.title}</div>
                                <div class="tree-item-path">${item.fullPath} ‚Ä¢ Order: ${item.data.order}</div>
                                ${item.data.description ? `<div style="font-size: 13px; color: #888; margin-top: 4px;">${item.data.description}</div>` : ''}
                            </div>
                            <div class="tree-item-actions">
                                <button class="btn btn-edit" onclick="editSubcategory('${item.id}', '${item.data.title.replace(/'/g, "\\'")}', '${(item.data.description || '').replace(/'/g, "\\'")}', ${item.data.order})">Edit</button>
                                <button class="btn btn-delete" onclick="deleteSubcategory('${item.id}')">Delete</button>
                            </div>
                        </div>
                    `;
                    subcategoriesList.appendChild(treeItem);
                });
            });
            
        }

        window.editSubcategory = async (id, title, description, order) => {
            const newTitle = prompt('Edit Subcategory Title:', title);
            if (newTitle === null) return;
            
            const newDescription = prompt('Edit Description:', description);
            if (newDescription === null) return;
            
            const newOrder = prompt('Edit Order:', order);
            if (newOrder === null) return;
            
            try {
                await updateDoc(doc(db, 'subcategories', id), {
                    title: newTitle,
                    description: newDescription || null,
                    order: parseInt(newOrder)
                });
                alert('Subcategory updated successfully!');
                loadAllData();
            } catch (error) {
                alert('Error updating subcategory: ' + error.message);
            }
        };

        window.deleteSubcategory = async (id) => {
            if (confirm('Are you sure? This will also delete all nested subcategories and materials.')) {
                try {
                    await deleteDoc(doc(db, 'subcategories', id));
                    alert('Subcategory deleted successfully!');
                    loadAllData();
                } catch (error) {
                    alert('Error deleting subcategory: ' + error.message);
                }
            }
        };

        // Study Materials
        document.getElementById('materialForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const parent = getSelectedParent('material');
            if (!parent) {
                alert('Please select a category first!');
                return;
            }
            
            // Materials must be added to subcategories, not categories
            if (parent.type === 'category') {
                alert('Please select a subcategory! Materials cannot be added directly to categories.');
                return;
            }
            
            const subcategoryId = parent.id;
            const title = document.getElementById('materialTitle').value;
            const description = document.getElementById('materialDescription').value;
            const order = parseInt(document.getElementById('materialOrder').value);
            const isAdFree = document.getElementById('materialIsAdFree').checked;
            const pdfFile = document.getElementById('materialPdf').files[0];
            const imageFiles = document.getElementById('materialImages').files;
            
            // Validate: At least one file (PDF or images) must be selected
            if (!pdfFile && imageFiles.length === 0) {
                alert('‚ö†Ô∏è Please upload at least one file:\n‚Ä¢ PDF document, OR\n‚Ä¢ One or more images, OR\n‚Ä¢ Both PDF and images');
                return;
            }
            
            try {
                document.getElementById('uploadProgress').style.display = 'block';
                let pdfDownloadURL = null;
                
                // Upload PDF if provided
                if (pdfFile) {
                    document.getElementById('progressText').textContent = 'Uploading PDF...';
                    
                    const pdfStorageRef = ref(storage, `study_materials/${Date.now()}_${pdfFile.name}`);
                    const pdfUploadTask = uploadBytesResumable(pdfStorageRef, pdfFile);
                    
                    await new Promise((resolve, reject) => {
                        pdfUploadTask.on('state_changed',
                            (snapshot) => {
                                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                document.getElementById('progressBar').value = progress;
                                document.getElementById('progressText').textContent = `Uploading PDF... ${Math.round(progress)}%`;
                            },
                            (error) => {
                                reject(error);
                            },
                            async () => {
                                pdfDownloadURL = await getDownloadURL(pdfUploadTask.snapshot.ref);
                                resolve();
                            }
                        );
                    });
                }
                
                // Upload images if any
                const imageUrls = [];
                if (imageFiles.length > 0) {
                    document.getElementById('progressText').textContent = 'Uploading images...';
                    
                    for (let i = 0; i < imageFiles.length; i++) {
                        const imageFile = imageFiles[i];
                        const imageStorageRef = ref(storage, `study_materials/images/${Date.now()}_${i}_${imageFile.name}`);
                        
                        document.getElementById('progressText').textContent = `Uploading image ${i + 1}/${imageFiles.length}...`;
                        
                        const imageSnapshot = await uploadBytesResumable(imageStorageRef, imageFile);
                        const imageUrl = await getDownloadURL(imageSnapshot.ref);
                        imageUrls.push(imageUrl);
                    }
                }
                
                // Save to Firestore
                await addDoc(collection(db, 'studyMaterials'), {
                    subcategoryId,
                    title,
                    description: description || null,
                    pdfUrl: pdfDownloadURL, // Can be null if only images
                    imageUrls: imageUrls,
                    isAdFree: isAdFree,
                    order,
                    createdAt: new Date().toISOString()
                });
                
                // Success message
                let message = isAdFree ? '‚úÖ Ad-free material uploaded successfully!' : '‚úÖ Material uploaded successfully!';
                if (pdfDownloadURL && imageUrls.length > 0) {
                    message += `\nüìÑ PDF + üì∑ ${imageUrls.length} image(s)`;
                } else if (pdfDownloadURL) {
                    message += '\nüìÑ PDF only';
                } else if (imageUrls.length > 0) {
                    message += `\nüì∑ ${imageUrls.length} image(s) only`;
                }
                alert(message);
                
                e.target.reset();
                document.getElementById('uploadProgress').style.display = 'none';
                loadMaterials();
            } catch (error) {
                alert('Error uploading material: ' + error.message);
                document.getElementById('uploadProgress').style.display = 'none';
            }
        });

        async function loadMaterials() {
            const q = query(collection(db, 'studyMaterials'), orderBy('order'));
            const snapshot = await getDocs(q);
            const subcategoriesSnapshot = await getDocs(collection(db, 'subcategories'));
            
            const subcategoriesMap = {};
            subcategoriesSnapshot.forEach(doc => {
                subcategoriesMap[doc.id] = doc.data().title;
            });
            
            const materialsList = document.getElementById('materialsList');
            materialsList.innerHTML = '';
            
            snapshot.forEach((doc) => {
                const data = doc.data();
                const subcategoryTitle = subcategoriesMap[data.subcategoryId] || 'Unknown';
                const isAdFree = data.isAdFree || false;
                const imageCount = (data.imageUrls && data.imageUrls.length) || 0;
                const hasPdf = data.pdfUrl && data.pdfUrl.length > 0;
                
                // Determine content type
                let contentType = '';
                let contentBadge = '';
                if (hasPdf && imageCount > 0) {
                    contentType = 'PDF + Images';
                    contentBadge = '<span style="background: #9c27b0; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px; font-weight: bold;">üìÑ+üì∑</span>';
                } else if (hasPdf) {
                    contentType = 'PDF Only';
                    contentBadge = '<span style="background: #f44336; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px; font-weight: bold;">üìÑ PDF</span>';
                } else if (imageCount > 0) {
                    contentType = 'Images Only';
                    contentBadge = '<span style="background: #2196f3; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px; font-weight: bold;">üì∑ IMG</span>';
                }
                
                const item = document.createElement('div');
                item.className = 'item';
                item.style.borderLeft = isAdFree ? '4px solid #4caf50' : '';
                item.innerHTML = `
                    <div class="item-info">
                        <h3>
                            ${isAdFree ? '<span style="color: #4caf50; margin-right: 8px;">üö´</span>' : ''}
                            ${data.title}
                            ${contentBadge}
                            ${isAdFree ? '<span style="background: linear-gradient(135deg, #4caf50, #66bb6a); color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px; font-weight: bold;">AD-FREE</span>' : ''}
                        </h3>
                        <p>Subcategory: ${subcategoryTitle} ‚Ä¢ ${data.description || 'No description'} ‚Ä¢ Order: ${data.order}</p>
                        <div style="margin-top: 8px;">
                            ${hasPdf ? `<a href="${data.pdfUrl}" target="_blank" style="color: #667eea; font-size: 14px; margin-right: 15px;">üìÑ View PDF</a>` : ''}
                            ${imageCount > 0 ? `<span style="color: #2196f3; font-size: 14px;">${hasPdf ? '' : 'üì∑ '}${imageCount} image(s)${hasPdf ? '' : ' only'}</span>` : ''}
                        </div>
                    </div>
                    <div class="item-actions" style="display: flex; align-items: center; gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <span style="font-size: 12px; font-weight: bold; color: #666;">Ad-Free:</span>
                            <label class="toggle-switch">
                                <input type="checkbox" ${isAdFree ? 'checked' : ''} onchange="toggleMaterialAdFree('${doc.id}', this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </label>
                        <button class="btn btn-edit" onclick="editMaterial('${doc.id}', '${data.title.replace(/'/g, "\\'")}', '${(data.description || '').replace(/'/g, "\\'")}', ${data.order})">Edit</button>
                        <button class="btn btn-delete" onclick="deleteMaterial('${doc.id}')">Delete</button>
                    </div>
                `;
                materialsList.appendChild(item);
            });
        }
        
        window.toggleMaterialAdFree = async (id, isAdFree) => {
            try {
                await updateDoc(doc(db, 'studyMaterials', id), {
                    isAdFree: isAdFree
                });
                loadMaterials();
            } catch (error) {
                alert('Error updating ad-free status: ' + error.message);
            }
        };

        window.editMaterial = async (id, title, description, order) => {
            const newTitle = prompt('Edit Material Title:', title);
            if (newTitle === null) return;
            
            const newDescription = prompt('Edit Description:', description);
            if (newDescription === null) return;
            
            const newOrder = prompt('Edit Order:', order);
            if (newOrder === null) return;
            
            try {
                await updateDoc(doc(db, 'studyMaterials', id), {
                    title: newTitle,
                    description: newDescription || null,
                    order: parseInt(newOrder)
                });
                alert('Material updated successfully!');
                loadAllData();
            } catch (error) {
                alert('Error updating material: ' + error.message);
            }
        };

        window.deleteMaterial = async (id) => {
            if (confirm('Are you sure you want to delete this material?')) {
                try {
                    await deleteDoc(doc(db, 'studyMaterials', id));
                    alert('Material deleted successfully!');
                    loadAllData();
                } catch (error) {
                    alert('Error deleting material: ' + error.message);
                }
            }
        };

        // Notifications
        const notificationForm = document.getElementById('notificationForm');
        if (notificationForm) {
            console.log('‚úÖ Notification form found');
            notificationForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const type = document.getElementById('notificationType').value;
                const title = document.getElementById('notificationTitle').value;
                const message = document.getElementById('notificationMessage').value;
                const audience = document.getElementById('notificationAudience').value;
                
                console.log('üì§ Sending notification:', { type, title, message, audience });
                
                try {
                    const docRef = await addDoc(collection(db, 'notifications'), {
                        type,
                        title,
                        message,
                        audience,
                        createdAt: new Date().toISOString(),
                        read: false
                    });
                    
                    console.log('‚úÖ Notification sent with ID:', docRef.id);
                    alert('üì¢ Notification sent successfully!\n\nCheck your app now!');
                    e.target.reset();
                    loadNotifications();
                } catch (error) {
                    console.error('‚ùå Error:', error);
                    alert('Error: ' + error.message);
                }
            });
        }

        window.loadNotifications = async function() {
            console.log('üîÑ Loading notifications...');
            const notificationsList = document.getElementById('notificationsList');
            if (!notificationsList) {
                console.error('‚ùå notificationsList element not found');
                return;
            }
            
            console.log('‚úÖ notificationsList element found');
            
            try {
                const q = query(collection(db, 'notifications'), orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);
                
                console.log(`üìä Found ${snapshot.size} notifications`);
                
                notificationsList.innerHTML = '';
                
                if (snapshot.empty) {
                    notificationsList.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No notifications sent yet</p>';
                    return;
                }
                
                const typeIcons = {
                    'new_category': 'üÜï',
                    'new_material': 'üìÑ',
                    'premium': 'üëë',
                    'announcement': 'üì£',
                    'update': 'üîÑ'
                };
                
                const audienceLabels = {
                    'all': 'All Users',
                    'free': 'Free Users',
                    'premium': 'Premium Users'
                };
                
                let count = 0;
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    console.log(`üìù Notification ${++count}:`, data);
                    const date = new Date(data.createdAt).toLocaleString();
                    
                    const item = document.createElement('div');
                    item.className = 'item';
                    item.innerHTML = `
                        <div class="item-info">
                            <h3>${typeIcons[data.type] || 'üì¢'} ${data.title}</h3>
                            <p>${data.message}</p>
                            <p style="font-size: 12px; color: #999; margin-top: 5px;">
                                üë• ${audienceLabels[data.audience]} ‚Ä¢ üìÖ ${date}
                            </p>
                        </div>
                        <div class="item-actions">
                            <button class="btn btn-delete" onclick="deleteNotification('${doc.id}')">Delete</button>
                        </div>
                    `;
                    notificationsList.appendChild(item);
                    console.log(`‚úÖ Added notification to list: ${data.title}`);
                });
                console.log(`‚ú® Total notifications displayed: ${count}`);
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        };

        window.deleteNotification = async (id) => {
            if (confirm('Delete this notification?')) {
                try {
                    await deleteDoc(doc(db, 'notifications', id));
                    alert('Deleted!');
                    loadNotifications();
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }
        };

        // Attach refresh button event listener
        const refreshBtn = document.getElementById('refreshNotificationsBtn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', loadNotifications);
            console.log('‚úÖ Refresh button event listener attached');
        }

        async function loadAllData() {
            await loadCategories();
            await loadSubcategories();
            await loadMaterials();
            await loadNotifications();
        }
    </script>
</body>
</html>
